package com.cs206.g2t2.service.serviceImpl;

import com.cs206.g2t2.data.request.team.TeamCreationRequest;
import com.cs206.g2t2.data.request.team.TeamUpdateRequest;
import com.cs206.g2t2.data.response.Response;
import com.cs206.g2t2.data.response.common.SuccessResponse;
import com.cs206.g2t2.exceptions.badRequest.DuplicatedTeamNameException;
import com.cs206.g2t2.exceptions.forbidden.ForbiddenException;
import com.cs206.g2t2.exceptions.notFound.TeamNotFoundException;
import com.cs206.g2t2.exceptions.notFound.UserNotFoundException;
import com.cs206.g2t2.models.BsTeam;
import com.cs206.g2t2.models.TeamMember;
import com.cs206.g2t2.models.User;
import com.cs206.g2t2.repository.BsTeamRepository;
import com.cs206.g2t2.repository.UserRepository;
import com.cs206.g2t2.service.services.BsTeamService;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.ArrayList;

@Service
@RequiredArgsConstructor
public class BsTeamServiceImpl implements BsTeamService {

    private final UserRepository userRepository;
    private final BsTeamRepository bsTeamRepository;

    private BsTeam saveAndReturnBsTeamInRepository(TeamCreationRequest request)
            throws DuplicatedTeamNameException, TeamNotFoundException{

        //Stores username in a variable
        String teamName = request.getTeamName();

        //Checks if Team's team name already exists in database
        if (bsTeamRepository.findByTeamName(teamName).isPresent()) {
            throw new DuplicatedTeamNameException(teamName);
        }

        //Creates bsTeam from TeamCreationRequest
        BsTeam bsTeam = BsTeam.builder()
                .teamName(request.getTeamName())
                .region(request.getRegion())
                .maximumTeamSize(request.getMaximumTeamSize())
                .imageString(null)
                .trophyRequirements(0)
                .min3v3Wins(0)
                .minDuoWins(0)
                .minSoloWins(0)
                .memberList(new ArrayList<TeamMember>())
                .build();

        //Saves bsTeam into repository
        bsTeamRepository.save(bsTeam);

        //Returns bsTeam stored in repository to caller
        return bsTeamRepository.findByTeamName(teamName).orElseThrow(() -> new TeamNotFoundException(teamName));
    }

    private void isAdminUser(User user, BsTeam bsTeam) {
        //Finds current user from the bsTeam and check if the user is an admin
        boolean found = false;
        for (TeamMember teamMember : bsTeam.getMemberList()) {
            if (teamMember.getUserId().equals(user.get_id()) && teamMember.getRole() == TeamMember.Role.ADMIN) {
                found = true;
            }
        }

        //If the user is not an admin member of the team, throw new ForbiddenException
        if (!found) { throw new ForbiddenException(); }
    }

    @Override
    public Response createBsTeam(TeamCreationRequest request, String username) throws UserNotFoundException {

        //Find user from userRepository
        User user = userRepository.findByUsername(username).orElseThrow(() -> new UserNotFoundException(username));
        TeamMember teamMember = TeamMember.builder()
                .userId(user.get_id())
                .role(TeamMember.Role.ADMIN)
                .joinDate(LocalDateTime.now())
                .build();

        //Obtains bsTeam from repository (Contains autogenerated _id)
        BsTeam bsTeam = saveAndReturnBsTeamInRepository(request);

        //Save the teamId into user's list of teamsId
        user.getTeams().add(bsTeam.get_id());

        //Save the teamMember into bsTeam
        bsTeam.getMemberList().add(teamMember);

        //Save both bsTeam and user into respective repository
        userRepository.save(user);
        bsTeamRepository.save(bsTeam);

        return SuccessResponse.builder()
                .message("Team has been created successfully")
                .build();
    }

    @Override
    public Response updateBsTeam(TeamUpdateRequest request, String username)
            throws UserNotFoundException, TeamNotFoundException, ForbiddenException {

        //Find Team from userRepository
        User user = userRepository.findByUsername(username).orElseThrow(() -> new UserNotFoundException(username));

        //Find Team from bsTeamRepository
        BsTeam bsTeam = bsTeamRepository.findByTeamName(request.getTeamName())
                .orElseThrow(() -> new TeamNotFoundException(request.getTeamName()));

        //Checks if current user is a admin user, else throws ForbiddenException
        isAdminUser(user, bsTeam);

        //Perform update of all fields
        bsTeam.setTrophyRequirements(request.getTrophyRequirements());
        bsTeam.setMin3v3Wins(request.getMin3v3Wins());
        bsTeam.setMinDuoWins(request.getMinDuoWins());
        bsTeam.setMinSoloWins(request.getMinSoloWins());
        if (request.getImageString() != null) {
            bsTeam.setImageString(request.getImageString());
        }

        //Save bsTeam into teamRepository
        bsTeamRepository.save(bsTeam);

        //Return SuccessResponse
        return SuccessResponse.builder()
                .message("Team has been updated successfully")
                .build();
    }
}
